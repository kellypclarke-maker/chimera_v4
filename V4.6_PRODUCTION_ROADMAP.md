# V4.6 Production Roadmap

This document is the prioritized production-hardening backlog for Project Chimera following the V4.5 A/B shadow audit.

Scope intent:
- Preserve the current 24-hour V4.5 A/B shadow test as a baseline.
- Do not expand to new sports or new verticals until the current NBA/NHL stack is hardened.
- Treat every `Blocker` item below as required before live capital deployment.

## Blocker

### 1. Persistent Shared Kalshi Feeder
Problem:
- The current shared feeder opens a fresh Kalshi WS snapshot connection every cycle instead of maintaining a persistent listener.
- This introduces connection churn, extra latency variance, and avoidable operational fragility.

Acceptance criteria:
- Replace snapshot-per-loop behavior with one persistent Kalshi WS listener process/task.
- The feeder must maintain a durable connection, resubscribe on reconnect, and publish updates incrementally.
- The feeder must expose freshness metadata per ticker and a global connection state.
- No `asyncio.run(...)` per polling cycle in the feeder hot path.
- During a 6-hour soak test, feeder reconnect count must remain bounded and explainable from actual disconnects, not normal operation.

### 2. Deterministic Sportsbook Arbitration for BoltOdds
Problem:
- The current BoltOdds experiment path allows multiple sportsbooks but effectively uses whichever update arrives last.
- This creates a race-condition oracle and invalidates the concept of a stable sharp source.

Acceptance criteria:
- Define an explicit book arbitration policy:
  - either `Pinnacle only`,
  - or `Pinnacle primary, DraftKings fallback`,
  - or a documented weighted blend.
- The arbitration rule must be encoded in config and logged at startup.
- Published matchup snapshots must record which sportsbook(s) were used.
- A later DraftKings update must not silently overwrite a Pinnacle-derived probability unless the configured arbitration policy permits it.
- Unit tests must prove deterministic output under mixed book update order.

### 3. Remove Manual Hardcoded Sports Probabilities
Problem:
- NBA/NHL Odds API specialists still contain manual fallback probabilities for HTTP 401 conditions.
- That is acceptable for shadow continuity only; it is unacceptable for live trading.

Acceptance criteria:
- Eliminate all manual hardcoded fallback probabilities from active live/shadow sports lookup paths.
- On auth failure, empty payload, or upstream denial, the system must:
  - mark the oracle unavailable,
  - log a clear critical warning,
  - skip pricing for affected markets.
- No sports order may be evaluated using hardcoded matchup probabilities.

### 4. Freshness-Safe Partial Line Assembly
Problem:
- BoltOdds one-sided update assembly can currently combine a fresh leg with a stale opposite leg from the same sportsbook.
- That can create mathematically invalid pair probabilities.

Acceptance criteria:
- Store per-side timestamps for home and away odds inside partial-line state.
- Reject pair publication when one side exceeds a configurable side-staleness threshold.
- Partial states must expire independently, not only by full matchup publication time.
- Logs must distinguish:
  - full valid pair,
  - partial waiting,
  - partial expired,
  - stale-leg rejected.

### 5. Quote Manager / Live Maker Protection
Problem:
- Maker logic currently prices quotes but does not yet provide production-grade protection against adverse selection after oracle movement.

Acceptance criteria:
- Build a quote manager that cancels or reprices resting maker orders when:
  - oracle probability moves through the quote,
  - edge drops below threshold,
  - quote age exceeds a limit,
  - feed freshness becomes stale.
- Cancellation logic must use Kalshi WS state, not slow REST polling.
- Quote manager must handle:
  - partial fills,
  - cancel acknowledgements,
  - in-flight replace protection,
  - duplicate cancel suppression.
- In replay or shadow simulation, adverse quotes must be withdrawn within the configured reaction window.

### 6. Probability Calibration Before Kelly
Problem:
- Fractional Kelly is not safe on an uncalibrated probability engine.

Acceptance criteria:
- Produce calibration reports for each active oracle path:
  - Odds API control,
  - BoltOdds experiment,
  - NBA live,
  - NHL live.
- Required metrics:
  - Brier score,
  - log loss,
  - reliability / calibration plots,
  - win-rate by decile bucket.
- Kelly sizing must not be enabled until calibration error is within the agreed tolerance band.

## High

### 7. Vig Removal Upgrade
Problem:
- Current de-vig is simple proportional normalization.
- This is too weak for production-grade sports pricing.

Acceptance criteria:
- Implement at least one advanced de-vig model:
  - Shin, or
  - Power method.
- Make the method configurable per oracle source.
- Produce side-by-side comparisons against current proportional normalization.
- Backtest results must show whether advanced de-vig improves CLV and realized shadow EV.

### 8. Closing Line Value (CLV) and Attribution
Problem:
- Current shadow outputs track EV but do not fully prove whether the model is beating the market.

Acceptance criteria:
- Add CLV tracking for every filled sports shadow order.
- Store:
  - quote time,
  - fill price,
  - later reference line,
  - closing reference line,
  - realized result.
- Reporting must separate:
  - model error,
  - execution error,
  - fee/slippage drag.

### 9. Live/Shadow Execution Gap Measurement
Problem:
- Taker and maker shadow assumptions are still optimistic relative to real execution quality.

Acceptance criteria:
- Add instrumentation for:
  - quote-to-action latency,
  - oracle update-to-order latency,
  - cancellation latency,
  - reprice latency,
  - fill latency.
- Produce a daily execution-gap report quantifying expected edge loss from latency and slippage.

### 10. Timezone-Safe Event Time Handling
Problem:
- BoltOdds fallback parsing of `info.when` is timezone-unsafe.
- Misclassified event timing corrupts adaptive polling and live/pregame state.

Acceptance criteria:
- All commence-time parsing must be timezone-explicit.
- If a source time string is ambiguous, the parser must reject it or map it with a documented source-specific timezone assumption.
- Add tests covering:
  - UTC timestamps,
  - local sportsbook strings,
  - DST boundaries,
  - date-rollover bridge cases.

### 11. Unified Release Branch and Config Discipline
Problem:
- The active codebase is split across at least two branches/worktrees.
- That is acceptable for research, not for production release control.

Acceptance criteria:
- Create one blessed release branch containing:
  - A/B architecture,
  - fee routing,
  - hot-idle fix,
  - roadmap-approved data-plane changes.
- Freeze config snapshots used for each production or shadow run.
- Each run must record:
  - branch,
  - commit SHA,
  - profile,
  - env hash or config fingerprint.

## Medium

### 12. Structured Metrics and Log Throttling
Problem:
- Heartbeat and feeder logs are too chatty for 24/7 production operation.

Acceptance criteria:
- Add structured metric emission for:
  - feed freshness,
  - reconnect count,
  - skipped reason counts,
  - order reprices,
  - stale quote count,
  - resolution backlog.
- Reduce repetitive heartbeat log spam while preserving operator visibility.
- A 24-hour run must keep log volume within a defined budget.

### 13. File I/O Safety for Multi-Process Logging
Problem:
- Root ledger append behavior is process-simple, not process-safe under concurrent writers.

Acceptance criteria:
- Add process-safe locking or move to per-process ledgers plus deterministic rollup.
- Header duplication and interleaved writes must be impossible under concurrent execution.
- A synthetic concurrency test must complete without corrupted CSV output.

### 14. Replay Harness
Problem:
- Live shadow runs are currently doing too much validation work that should be reproducible offline.

Acceptance criteria:
- Build a deterministic replay harness for:
  - Kalshi market data,
  - oracle updates,
  - order state transitions.
- Replay must support side-by-side control vs experiment evaluation from recorded data.
- Core production bugs must be reproducible without live APIs.

### 15. Explicit Stale-Feed Kill Switches
Problem:
- There are stale semantics in the code, but not yet a fully unified kill-switch policy across the stack.

Acceptance criteria:
- Define and enforce stop-trading conditions for:
  - stale oracle feed,
  - stale Kalshi feed,
  - repeated reconnect failures,
  - missing commence-time metadata,
  - unresolved sportsbook arbitration.
- Live mode must refuse new orders when any critical data plane is degraded.

## Low

### 16. Expansion to New Verticals
Problem:
- LoL, new crypto assets, and broader weather coverage are attractive, but they dilute focus before the core engine is proven.

Acceptance criteria:
- No new vertical is added until all `Blocker` items are complete and signed off.
- Expansion candidates must ship with:
  - data source reliability review,
  - mapping coverage,
  - calibration plan,
  - execution plan,
  - failure-mode analysis.

### 17. Category and Report Polish
Problem:
- Reporting is usable but not yet sufficient for production operating review.

Acceptance criteria:
- Daily reports must include:
  - performance by category,
  - performance by oracle source,
  - maker vs taker split,
  - skip-reason histogram,
  - CLV summary,
  - stale-feed incidents,
  - reconnect incidents.

## Recommended V4.6 Sequencing

1. Persistent shared Kalshi feeder
2. Deterministic BoltOdds sportsbook arbitration
3. Remove manual hardcoded sports probabilities
4. Freshness-safe partial line assembly
5. Quote manager / live maker protection
6. Calibration and CLV instrumentation
7. Advanced de-vig
8. Kelly sizing only after calibration sign-off
9. Only then consider expansion

## Live Capital Gate

Chimera should remain out of live-capital mode until all of the following are true:
- All `Blocker` items are complete.
- CLV is positive over a statistically meaningful sample.
- Probability calibration is signed off.
- Maker quote cancellation latency is within the agreed bound.
- No hardcoded sports probability fallback remains in the active stack.
- One blessed release branch and runbook exist.
